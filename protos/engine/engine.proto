syntax = "proto3";

package engine;

// EngineService defines the interface for database engine plugins.
// Engine plugins are responsible for parsing SQL statements and extracting
// information about parameters and result columns.
service EngineService {
  // Parse parses SQL statements and returns the processed SQL along with
  // information about parameters and result columns.
  rpc Parse (ParseRequest) returns (ParseResponse);
}

// ParseRequest contains the SQL to parse and either schema or connection parameters.
message ParseRequest {
  // The SQL query text to parse.
  string sql = 1;
  
  // Either schema SQL or connection parameters for database-only mode.
  oneof schema_source {
    // Schema SQL text (schema.sql) for schema-based parsing.
    string schema_sql = 2;
    
    // Connection parameters for database-only mode.
    ConnectionParams connection_params = 3;
  }
}

// ConnectionParams contains database connection parameters for database-only mode.
message ConnectionParams {
  // Database connection string or DSN.
  string dsn = 1;
  
  // Additional connection parameters as key-value pairs.
  map<string, string> params = 2;
}

// ParseResponse contains the processed SQL and information about parameters and columns.
message ParseResponse {
  // The processed SQL query text. In the simplest case, this is the same as input.
  // In complex cases, wildcards (*) may be expanded based on the schema.
  string sql = 1;
  
  // Parameters found in the query (e.g., $1, ?, :name, sqlc.arg(), etc.).
  repeated Parameter parameters = 2;
  
  // Result columns that the query returns.
  repeated Column columns = 3;
}

// Parameter represents a query parameter.
message Parameter {
  // Parameter name (if named) or empty for positional parameters.
  string name = 1;
  
  // Parameter position (1-based) for positional parameters.
  int32 position = 2;
  
  // SQL data type of the parameter.
  string data_type = 3;
  
  // Whether the parameter is nullable.
  bool nullable = 4;
  
  // Whether the parameter is an array type.
  bool is_array = 5;
  
  // Array dimensions if is_array is true.
  int32 array_dims = 6;
}

// Column represents a result column.
message Column {
  // Column name.
  string name = 1;
  
  // SQL data type of the column.
  string data_type = 2;
  
  // Whether the column is nullable.
  bool nullable = 3;
  
  // Whether the column is an array type.
  bool is_array = 4;
  
  // Array dimensions if is_array is true.
  int32 array_dims = 5;
  
  // Table name this column belongs to (if known).
  string table_name = 6;
  
  // Schema name this column belongs to (if known).
  string schema_name = 7;
}

